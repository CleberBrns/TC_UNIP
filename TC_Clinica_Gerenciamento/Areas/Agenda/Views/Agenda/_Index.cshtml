@{
    var user = (TCC_Unip.Models.Servico.Usuario)ViewBag.Usuario;
}

@if (user != null)
{
    <link href="~/Content/css/tabsAgenda.css" rel="stylesheet" />

    <div class="row">
        <div class="col-md-12">
            <div style="text-align: right">
                <button type="button" class="btn btn-primary" id="btnNovaConsulta">
                    <span class="glyphicon glyphicon-plus"></span>
                    Nova Consulta
                </button>
            </div>
        </div>
        <div class="col-md-12 col-sm-12" style="padding-top: 2%">
            <div>
                <form>
                    <ul id="abas">
                        <li>
                            <a href="#" name="abaCalendario" class="abaCalendario" carregado="false">
                                Calendário
                            </a>
                        </li>
                        <li>
                            <a href="#" name="abaGridConsultas" class="abaGridConsultas" carregado="false">
                                Listagem
                            </a>
                        </li>
                    </ul>
                    <div id="conteudo">
                        <div id="abaCalendario">
                            <div>@Html.Partial("_Calendario")</div>
                        </div>                        
                        <div id="abaGridConsultas">
                            <div class="form-inline">
                                <div class="col-md-10" style="margin-left: 14%">
                                    <div style="display:inline-flex; width: 100%;">
                                        <div>
                                            <label class="control-label">Exibir De</label>
                                        </div>
                                        <div class="input-group" style="padding-left: 2%; padding-right: 2%; width: 30%">
                                            <div>
                                                <input class="form-control dataPesquisa alinhamentoSelect" type="text" id="dataInicio">
                                            </div>
                                            <span class="input-group-addon">
                                                <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
                                            </span>
                                        </div>
                                        <div>
                                            <label class="control-label">Até</label>
                                        </div>
                                        <div class="input-group" style="padding-left: 2%; padding-right: 2%; width: 30%">
                                            <div>
                                                <input class="form-control dataPesquisa alinhamentoSelect" type="text" id="dataFim">
                                            </div>
                                            <span class="input-group-addon">
                                                <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
                                            </span>
                                        </div>
                                        <div>
                                            <input type="button" class="btn btn-primary" id="btPesquisar" value="Ok" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="divGridConsultas"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        $(document).ready(function () {
            //Abas
            $("#conteudo").find("[id^='aba']").hide(); // Hide all conteudo
            $("#abas li:first").attr("id", "current"); // Activate the first aba
            $("#conteudo #abaCalendario").fadeIn(); // Show first aba's conteudo

            $('#abas a').click(function (e) {
                e.preventDefault();

                if ($(this).closest("li").attr("id") === "current") { //detection for current aba
                    return;
                }
                else {

                    $("#conteudo").find("[id^='aba']").hide(); // Hide all conteudo
                    $("#abas li").attr("id", ""); //Reset id's
                    $(this).parent().attr("id", "current"); // Activate this
                    $('#' + $(this).attr('name')).fadeIn(); // Show conteudo for the current aba
                }
            });
            //End Abas

        });

    $("#btnNovaConsulta").on('click', function () {
        listagemAgenda.modalCadastrar();
    });

    $('#abas a').click(function (e) {
        e.preventDefault();
        listagemAgenda.carregaDivDaTab(this);
    });

    var listagemAgenda = {

        modalCadastrar: function () {
            $.ajax({
                url: "@Url.Action("ModalCadastrar", "Agenda")",
                type: "GET",
                success: function (html) {
                    bootbox.dialog({
                        title: "Cadastrar Consulta",
                        message: html
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    validacao.errorAjax(jqXHR, textStatus, errorThrown);
                }
            });
        },

        carregaDivDaTab: function (object) {

            var carregado = $(object).attr("carregado");
            var tabName = $(object).attr('name');

            if (tabName === 'abaCalendario') {
                if (carregado === undefined || carregado === "false") {
                    listagemAgenda.listaAgendaCalendario(object, true);
                }
            }
            else if (tabName === 'abaGridConsultas') {
                if (carregado === undefined || carregado === "false") {
                    listagemAgenda.listaAgendaGrid(object, true);
                }
            }

        },

        listaAgendaCalendario: function (object, getFromSession) {

        },

        listaAgendaGrid: function (object, getFromSession) {

            listagemAgenda.getAgendaDoDia(object, getFromSession);
        },

        getAgendaDoDia: function (object, getFromSession) {

            $.ajax({
                url: "@Url.Action("ListaAgendaDoDia", "Agenda")",
                data: { getFromSession: getFromSession },
                type: "GET",
                success: function (result) {
                    if (result.mensagensRetorno === undefined || result.mensagensRetorno === null) {
                        $('#divGridConsultas').html(result);
                        $(object).attr("carregado", "true");
                    }
                    else {
                        var retorno = result.mensagensRetorno;
                        swal({
                            title: '',
                            text: retorno.MensagemExibicao,
                            type: 'warning',
                            confirmButtonColor: '#10386B',
                            allowOutsideClick: false
                        });
                        console.log(retorno.MensagemAnalise);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    validacao.errorAjax(jqXHR, textStatus, errorThrown);
                }
            });
        },

        getAgendaPorDatas: function (dataInicio, dataFim) {

            if (listagemAgenda.validaBuscaPorDatas(dataInicio, dataFim)) {

                $.ajax({
                    url: "@Url.Action("ListaConsultasPorDatas", "Agenda")",
                    data: { dataInicio: dataInicio, dataFim: dataFim },
                    type: "GET",
                    success: function (result) {
                        if (result.mensagensRetorno === undefined || result.mensagensRetorno === null) {
                            $('#divGridConsultas').html(result);
                            $(object).attr("carregado", "true");
                        }
                        else {
                            var retorno = result.mensagensRetorno;
                            swal({
                                title: '',
                                text: retorno.MensagemExibicao,
                                type: 'warning',
                                confirmButtonColor: '#10386B',
                                allowOutsideClick: false
                            });
                            console.log(retorno.MensagemAnalise);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        validacao.errorAjax(jqXHR, textStatus, errorThrown);
                    }
                });
            }            
        },

        validaBuscaPorDatas: function (dataOne, dataTwo) {
            var ehValido = true;

            if ((dataOne !== undefined && dataOne !== "") && (dataTwo !== undefined && dataTwo !== "")) {

                var arrDataUm = dataOne.split("/");
                var dataUm = new Date(arrDataUm[2], arrDataUm[1] - 1, arrDataUm[0]);

                var arrDataDois = dataTwo.split("/");
                var dataDois = new Date(arrDataDois[2], arrDataDois[1] - 1, arrDataDois[0]);

                if (dataUm > dataDois) {

                    swal({
                        title: '',
                        text: "A Data incial não pode ser maior que a final.",
                        type: 'warning',
                        confirmButtonColor: '#10386B',
                        allowOutsideClick: false
                    });

                    ehValido = false;
                }

                return ehValido;
            }
            else {

                swal({
                    title: '',
                    text: "Para realizar a pesquisa, os campos de Data devem ser ambos preenchidos.",
                    type: 'warning',
                    confirmButtonColor: '#10386B',
                    allowOutsideClick: false
                });

                return false;
            }            
        }
    };

    </script>
}